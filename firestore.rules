rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isValidDNI(dni) {
      return dni.matches('^[0-9]{7,8}$');
    }
    
    function isEventoActivo(eventoId) {
      return get(/databases/$(database)/documents/eventos/$(eventoId)).data.activo == true;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Colección de eventos
    match /eventos/{eventoId} {
      // Permitir lectura pública de eventos activos
      allow read: if resource.data.activo == true;
      
      // Admin autenticado puede hacer todo
      allow read, create, update, delete: if isAuthenticated();
      
      // Subcolección de registros por evento
      match /registros/{dni} {
        // Permitir crear registro si:
        // 1. El DNI coincide con el documento (evita manipulación)
        // 2. El evento está activo
        // 3. El DNI es válido (7-8 dígitos)
        // 4. Tiene todos los campos requeridos
        allow create: if request.resource.data.dni == dni 
                      && isValidDNI(dni)
                      && isEventoActivo(eventoId)
                      && request.resource.data.keys().hasAll(['nombre', 'apellido', 'email', 'dni', 'timestamp', 'eventoId']);
        
        // Admin autenticado puede leer todo
        allow read: if isAuthenticated();
        
        // No permitir actualización ni eliminación (registros inmutables)
        allow update, delete: if false;
      }
    }
  }
}
