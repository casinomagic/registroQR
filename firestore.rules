rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isValidDNI(dni) {
      return dni.matches('^[0-9]{7,8}$');
    }
    
    function isEventoActivo(eventoId) {
      return get(/databases/$(database)/documents/eventos/$(eventoId)).data.activo == true;
    }
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Colección de configuración
    match /configuracion/{configId} {
      // Permitir lectura pública de la configuración visual
      allow read: if true;
      
      // Solo admin autenticado puede modificar
      allow create, update, delete: if isAuthenticated();
    }
    
    // Colección de eventos
    match /eventos/{eventoId} {
      // Permitir lectura pública de eventos activos (para obtener el evento activo)
      // Esto permite tanto get() individual como list() con query
      allow read: if resource == null || resource.data.activo == true;
      
      // Admin autenticado puede hacer todo
      allow read, write: if isAuthenticated();
      
      // Subcolección de registros por evento
      match /registros/{dni} {
        // Permitir crear registro si:
        // 1. El DNI coincide con el documento (evita manipulación)
        // 2. El evento está activo
        // 3. El DNI es válido (7-8 dígitos)
        // 4. Tiene todos los campos requeridos
        allow create: if request.resource.data.dni == dni 
                      && isValidDNI(dni)
                      && isEventoActivo(eventoId)
                      && request.resource.data.keys().hasAll(['nombreCompleto', 'email', 'dni', 'timestamp', 'eventoId']);
        
        // Permitir lectura pública de un DNI específico (para verificar duplicados)
        // Solo si el evento está activo
        allow read: if isValidDNI(dni) && isEventoActivo(eventoId);
        
        // Admin autenticado puede leer todo con collectionGroup
        allow list: if isAuthenticated();
        
        // No permitir actualización ni eliminación (registros inmutables)
        allow update, delete: if false;
      }
    }
  }
}
