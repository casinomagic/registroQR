<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Casino Magic</title>
    <link rel="stylesheet" href="css/admin.min.css">
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div class="login-container" id="loginScreen">
        <h1>üé∞ Panel de Administraci√≥n</h1>
        <h3 style="text-align: center; color: #666; margin-bottom: 20px;">Casino Magic</h3>
        <input type="email" id="emailInput" placeholder="Email" autocomplete="email" style="margin-bottom: 10px;">
        <input type="password" id="passwordInput" placeholder="Contrase√±a" autocomplete="current-password">
        <button onclick="login()">Ingresar</button>
        <div id="loginError" style="color: red; text-align: center; margin-top: 10px;"></div>
        <p style="text-align: center; color: #999; font-size: 12px; margin-top: 20px;">
            Usar credenciales de Firebase Authentication
        </p>
    </div>

    <!-- PANEL DE ADMINISTRACI√ìN -->
    <div class="admin-panel" id="adminPanel">
        <!-- Header -->
        <div class="admin-header">
            <div>
                <h1>üé∞ Panel de Administraci√≥n</h1>
                <p style="color: #666;">Casino Magic - Gesti√≥n de Eventos</p>
            </div>
            <div>
                <button class="btn btn-secondary" onclick="mostrarConfiguracion()">‚öôÔ∏è Configuraci√≥n</button>
                <button class="btn btn-primary" onclick="mostrarModalNuevoEvento()">+ Nuevo Evento</button>
                <button class="btn btn-danger" onclick="FirebaseAdmin.cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Estad√≠sticas Generales -->
        <div class="cards-grid" id="statsGrid">
            <!-- Se llenan din√°micamente -->
        </div>

        <!-- Lista de Eventos -->
        <div class="content-section">
            <h2>üìÖ Eventos</h2>
            <div id="eventosLista">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Registros del Evento Seleccionado -->
        <div class="content-section" id="registrosSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üë• Registros: <span id="eventoSeleccionadoNombre"></span></h2>
                <div>
                    <button class="btn btn-success" onclick="exportarRegistrosActuales()">üì• Exportar CSV</button>
                    <button class="btn btn-secondary" onclick="cerrarRegistros()">Cerrar</button>
                </div>
            </div>
            
            <div class="form-group">
                <input type="text" id="searchDNI" placeholder="Buscar por DNI..." onkeyup="filtrarRegistros()">
            </div>
            
            <div id="registrosTabla">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Secci√≥n de Configuraci√≥n Visual -->
        <div class="content-section" id="configuracionSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>‚öôÔ∏è Configuraci√≥n Visual</h2>
                <button class="btn btn-secondary" onclick="cerrarConfiguracion()">Cerrar</button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Columna izquierda: Configuraci√≥n -->
                <div>
                    <h3 style="margin-bottom: 15px;">üé® Colores</h3>
                    <div class="form-group">
                        <label>Color Principal:</label>
                        <input type="color" id="configColorPrimario" value="#161337">
                    </div>
                    <div class="form-group">
                        <label>Color Secundario:</label>
                        <input type="color" id="configColorSecundario" value="#FFD700">
                    </div>
                    <div class="form-group">
                        <label>Color Fondo:</label>
                        <input type="color" id="configColorFondo" value="#f5f5f5">
                    </div>

                    <h3 style="margin: 25px 0 15px 0;">üñºÔ∏è Logos (URLs)</h3>
                    <div class="form-group">
                        <label>Logo Header:</label>
                        <input type="text" id="configLogoHeader" placeholder="URL del logo header">
                        <small style="color: #666;">Ejemplo: img/Estrella-Solita-Blanca.png</small>
                    </div>
                    <div class="form-group">
                        <label>Logo Footer:</label>
                        <input type="text" id="configLogoFooter" placeholder="URL del logo footer">
                        <small style="color: #666;">Ejemplo: img/Pie blanco.png</small>
                    </div>

                    <h3 style="margin: 25px 0 15px 0;">üìù Textos</h3>
                    <div class="form-group">
                        <label>T√≠tulo Principal:</label>
                        <input type="text" id="configTitulo" placeholder="Particip√° de los sorteos">
                    </div>
                    <div class="form-group">
                        <label>Mensaje de √âxito:</label>
                        <textarea id="configMensajeExito" rows="2" placeholder="¬°Registro exitoso!">¬°Te registraste con √©xito!</textarea>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="guardarConfiguracion()" style="width: 100%;">üíæ Guardar Configuraci√≥n</button>
                    </div>
                </div>

                <!-- Columna derecha: Vista Previa -->
                <div>
                    <h3 style="margin-bottom: 15px;">üëÅÔ∏è Vista Previa</h3>
                    <div id="vistaPrevia" style="border: 2px solid #ddd; border-radius: 8px; padding: 20px; background: white; min-height: 400px;">
                        <p style="color: #666; text-align: center; padding: 40px 0;">
                            Los cambios se aplicar√°n al guardar la configuraci√≥n
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Evento -->
    <div class="modal" id="modalNuevoEvento">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Evento</h2>
                <span class="close-modal" onclick="cerrarModal()">&times;</span>
            </div>
            <form onsubmit="crearEvento(event)">
                <div class="form-group">
                    <label>ID del Evento (sin espacios):</label>
                    <input type="text" id="nuevoEventoId" required placeholder="ej: sorteo-febrero-2026">
                </div>
                <div class="form-group">
                    <label>Nombre del Evento:</label>
                    <input type="text" id="nuevoEventoNombre" required placeholder="ej: Sorteo Febrero 2026">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Fecha Inicio:</label>
                        <input type="date" id="nuevoEventoFechaInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha Fin:</label>
                        <input type="date" id="nuevoEventoFechaFin" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n:</label>
                    <textarea id="nuevoEventoDescripcion" rows="3" placeholder="Descripci√≥n del evento..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="nuevoEventoActivo">
                        Activar este evento inmediatamente
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Crear Evento</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-db.min.js"></script>
    <script src="js/firebase-admin.min.js"></script>
    
    <script>
        // Inicializar Firebase PRIMERO
        firebase.initializeApp(window.FIREBASE_CONFIG);
        console.log('‚úÖ Firebase inicializado');
        
        let eventosData = [];
        let registrosActuales = [];
        let eventoSeleccionadoId = null;

        // Al cargar la p√°gina
        window.onload = function() {
            if (FirebaseAdmin.verificarSesion()) {
                iniciarPanel();
            }
        };

        // Login
        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!email || !password) {
                errorDiv.textContent = '‚ùå Ingrese email y contrase√±a';
                setTimeout(() => errorDiv.textContent = '', 3000);
                return;
            }
            
            try {
                // Intentar login con Firebase Authentication
                await loginWithFirebase(email, password);
                FirebaseAdmin.guardarSesionAdmin();
                iniciarPanel();
            } catch (error) {
                let mensaje = '‚ùå Error de autenticaci√≥n';
                if (error.code === 'auth/user-not-found') {
                    mensaje = '‚ùå Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    mensaje = '‚ùå Contrase√±a incorrecta';
                } else if (error.code === 'auth/invalid-email') {
                    mensaje = '‚ùå Email inv√°lido';
                } else if (error.code === 'auth/too-many-requests') {
                    mensaje = '‚ùå Demasiados intentos. Espere un momento';
                }
                errorDiv.textContent = mensaje;
                setTimeout(() => errorDiv.textContent = '', 5000);
            }
        }

        // Iniciar panel
        async function iniciarPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Inicializar Firebase
            if (!FirebaseDB.initFirestore()) {
                alert('Error conectando con Firebase');
                return;
            }
            
            // Cargar datos
            await cargarEstadisticas();
            await cargarEventos();
        }

        // Cargar estad√≠sticas
        async function cargarEstadisticas() {
            const statsGrid = document.getElementById('statsGrid');
            const eventos = await FirebaseAdmin.getAllEventos();
            
            let totalRegistros = 0;
            let eventosActivos = 0;
            
            for (const evento of eventos) {
                const stats = await FirebaseAdmin.getEstadisticasEvento(evento.id);
                totalRegistros += stats.total;
                if (evento.activo) eventosActivos++;
            }
            
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Eventos</h3>
                    <div class="number">${eventos.length}</div>
                </div>
                <div class="stat-card">
                    <h3>Eventos Activos</h3>
                    <div class="number">${eventosActivos}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Registros</h3>
                    <div class="number">${totalRegistros}</div>
                </div>
            `;
        }

        // Cargar eventos
        async function cargarEventos() {
            const listaDiv = document.getElementById('eventosLista');
            listaDiv.innerHTML = '<div class="spinner"></div>';
            
            eventosData = await FirebaseAdmin.getAllEventos();
            
            if (eventosData.length === 0) {
                listaDiv.innerHTML = '<p>No hay eventos creados. Crea uno nuevo.</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>Nombre</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Estado</th><th>Registros</th><th>Acciones</th></tr></thead><tbody>';
            
            for (const evento of eventosData) {
                const stats = await FirebaseAdmin.getEstadisticasEvento(evento.id);
                const fechaInicio = evento.fechaInicio?.toDate ? evento.fechaInicio.toDate().toLocaleDateString() : 'N/A';
                const fechaFin = evento.fechaFin?.toDate ? evento.fechaFin.toDate().toLocaleDateString() : 'N/A';
                
                html += `
                    <tr>
                        <td><strong>${evento.id}</strong></td>
                        <td>${evento.nombre}</td>
                        <td>${fechaInicio}</td>
                        <td>${fechaFin}</td>
                        <td>${evento.activo ? '<span class="badge badge-success">ACTIVO</span>' : '<span class="badge badge-danger">INACTIVO</span>'}</td>
                        <td><strong>${stats.total}</strong></td>
                        <td>
                            <button class="btn ${evento.activo ? 'btn-warning' : 'btn-success'}" onclick="toggleEvento('${evento.id}', ${!evento.activo})" style="padding: 5px 10px; font-size: 12px;">
                                ${evento.activo ? 'Desactivar' : 'Activar'}
                            </button>
                            <button class="btn btn-info" onclick="verRegistros('${evento.id}', '${evento.nombre}')" style="padding: 5px 10px; font-size: 12px;">
                                Ver Registros
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            listaDiv.innerHTML = html;
        }

        // Toggle evento activo/inactivo
        async function toggleEvento(eventoId, activo) {
            try {
                await FirebaseAdmin.toggleEventoActivo(eventoId, activo);
                await cargarEstadisticas();
                await cargarEventos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Ver registros de un evento
        async function verRegistros(eventoId, nombreEvento) {
            eventoSeleccionadoId = eventoId;
            document.getElementById('eventoSeleccionadoNombre').textContent = nombreEvento;
            document.getElementById('registrosSection').style.display = 'block';
            document.getElementById('registrosTabla').innerHTML = '<div class="spinner"></div>';
            
            registrosActuales = await FirebaseAdmin.getAllRegistrosEvento(eventoId);
            mostrarRegistros(registrosActuales);
        }

        // Mostrar registros en tabla
        function mostrarRegistros(registros) {
            const tablaDiv = document.getElementById('registrosTabla');
            
            if (registros.length === 0) {
                tablaDiv.innerHTML = '<p>No hay registros en este evento.</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>DNI</th><th>Nombre</th><th>Email</th><th>Tel√©fono</th><th>Fecha Registro</th><th>Estado</th></tr></thead><tbody>';
            
            registros.forEach(r => {
                const fecha = r.timestamp ? new Date(r.timestamp).toLocaleString() : 'N/A';
                html += `
                    <tr>
                        <td><strong>${r.dni}</strong></td>
                        <td>${r.nombreCompleto}</td>
                        <td>${r.email || '-'}</td>
                        <td>${r.telefono || '-'}</td>
                        <td>${fecha}</td>
                        <td><span class="badge badge-success">${r.estado || 'ACTIVO'}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            tablaDiv.innerHTML = html;
        }

        // Filtrar registros por DNI
        function filtrarRegistros() {
            const searchTerm = document.getElementById('searchDNI').value.toLowerCase();
            const filtrados = registrosActuales.filter(r => r.dni.includes(searchTerm));
            mostrarRegistros(filtrados);
        }

        // Cerrar vista de registros
        function cerrarRegistros() {
            document.getElementById('registrosSection').style.display = 'none';
            eventoSeleccionadoId = null;
        }

        // Exportar registros
        function exportarRegistrosActuales() {
            if (registrosActuales.length === 0) {
                alert('No hay registros para exportar');
                return;
            }
            const nombreEvento = document.getElementById('eventoSeleccionadoNombre').textContent;
            FirebaseAdmin.exportarCSV(registrosActuales, nombreEvento);
        }

        // Modal nuevo evento
        function mostrarModalNuevoEvento() {
            document.getElementById('modalNuevoEvento').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalNuevoEvento').style.display = 'none';
        }

        // Crear evento
        async function crearEvento(event) {
            event.preventDefault();
            
            const eventoId = document.getElementById('nuevoEventoId').value.trim().toLowerCase().replace(/\s+/g, '-');
            const nombre = document.getElementById('nuevoEventoNombre').value;
            const fechaInicio = new Date(document.getElementById('nuevoEventoFechaInicio').value);
            const fechaFin = new Date(document.getElementById('nuevoEventoFechaFin').value);
            const descripcion = document.getElementById('nuevoEventoDescripcion').value;
            const activo = document.getElementById('nuevoEventoActivo').checked;
            
            try {
                await FirebaseDB.createOrUpdateEvento(eventoId, {
                    nombre,
                    fechaInicio,
                    fechaFin,
                    descripcion,
                    activo
                });
                
                cerrarModal();
                await cargarEstadisticas();
                await cargarEventos();
                alert('‚úÖ Evento creado exitosamente');
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        // ===== CONFIGURACI√ìN VISUAL =====
        
        // Mostrar panel de configuraci√≥n
        async function mostrarConfiguracion() {
            document.getElementById('configuracionSection').style.display = 'block';
            await cargarConfiguracion();
        }

        // Cerrar configuraci√≥n
        function cerrarConfiguracion() {
            document.getElementById('configuracionSection').style.display = 'none';
        }

        // Cargar configuraci√≥n actual
        async function cargarConfiguracion() {
            try {
                const db = firebase.firestore();
                const doc = await db.collection('configuracion').doc('visual').get();
                
                if (doc.exists) {
                    const config = doc.data();
                    document.getElementById('configColorPrimario').value = config.colorPrimario || '#161337';
                    document.getElementById('configColorSecundario').value = config.colorSecundario || '#FFD700';
                    document.getElementById('configColorFondo').value = config.colorFondo || '#f5f5f5';
                    document.getElementById('configLogoHeader').value = config.logoHeader || 'img/Estrella-Solita-Blanca.png';
                    document.getElementById('configLogoFooter').value = config.logoFooter || 'img/Pie blanco.png';
                    document.getElementById('configTitulo').value = config.titulo || 'Particip√° de los sorteos';
                    document.getElementById('configMensajeExito').value = config.mensajeExito || '¬°Te registraste con √©xito!';
                } else {
                    console.log('No hay configuraci√≥n guardada, usando valores por defecto');
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
            }
        }

        // Guardar configuraci√≥n
        async function guardarConfiguracion() {
            try {
                const config = {
                    colorPrimario: document.getElementById('configColorPrimario').value,
                    colorSecundario: document.getElementById('configColorSecundario').value,
                    colorFondo: document.getElementById('configColorFondo').value,
                    logoHeader: document.getElementById('configLogoHeader').value,
                    logoFooter: document.getElementById('configLogoFooter').value,
                    titulo: document.getElementById('configTitulo').value,
                    mensajeExito: document.getElementById('configMensajeExito').value,
                    actualizadoEn: firebase.firestore.FieldValue.serverTimestamp()
                };

                const db = firebase.firestore();
                await db.collection('configuracion').doc('visual').set(config);
                
                alert('‚úÖ Configuraci√≥n guardada exitosamente');
            } catch (error) {
                alert('‚ùå Error guardando configuraci√≥n: ' + error.message);
                console.error(error);
            }
        }
    </script>
</body>
</html>
