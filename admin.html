<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Casino Magic</title>
    <link rel="stylesheet" href="css/admin.min.css">
</head>

<body>
    <!-- PANTALLA DE LOGIN -->
    <div class="login-container" id="loginScreen">
        <h1>Panel de Administración</h1>
        <h3 style="text-align: center; color: #666; margin-bottom: 20px;">Casino Magic</h3>
        <input type="email" id="emailInput" placeholder="Email" autocomplete="email" style="margin-bottom: 10px;">
        <input type="password" id="passwordInput" placeholder="Contraseña" autocomplete="current-password">
        <button onclick="login()">Ingresar</button>
        <div id="loginError" style="color: red; text-align: center; margin-top: 10px;"></div>
        <p style="text-align: center; color: #999; font-size: 12px; margin-top: 20px;">
            Usar credenciales de Firebase Authentication
        </p>
    </div>

    <!-- PANEL DE ADMINISTRACIÓN -->
    <div class="admin-panel" id="adminPanel">
        <!-- Header -->
        <div class="admin-header">
            <div>
                <h1>Panel de Administración</h1>
                <p style="color: #666;">Casino Magic - Gestión de Eventos</p>
            </div>
            <div>
                <button class="btn btn-primary" id="btnNuevoEvento" onclick="mostrarModalNuevoEvento()"
                    style="display: none;">+ Nuevo
                    Evento</button>
                <button class="btn btn-danger" onclick="FirebaseAdmin.cerrarSesion()">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Estadísticas Generales -->
        <div class="cards-grid" id="statsGrid">
            <!-- Se llenan dinámicamente -->
        </div>

        <!-- Lista de Eventos -->
        <div class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Evento Activo</h2>
            </div>

            <!-- Alerta informativa -->
            <div class="alert alert-info" style="margin-bottom: 20px; display: none;">
                <strong>Importante:</strong> Solo un evento puede estar activo a la vez. Al activar un evento,
                cualquier otro evento activo se desactivará automáticamente.
            </div>

            <div id="eventosLista">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Registros del Evento Seleccionado -->
        <div class="content-section" id="registrosSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Registros: <span id="eventoSeleccionadoNombre"></span></h2>
                <div>
                    <button class="btn btn-success" onclick="exportarRegistrosActuales()">Exportar CSV</button>
                    <button class="btn btn-secondary" onclick="cerrarRegistros()">Cerrar</button>
                </div>
            </div>

            <div class="form-group">
                <input type="text" id="searchDNI" placeholder="Buscar por DNI..." onkeyup="filtrarRegistros()">
            </div>

            <div id="registrosTabla">
                <div class="spinner"></div>
            </div>
        </div>


    </div>

    <!-- Modal Nuevo Evento -->
    <div class="modal" id="modalNuevoEvento">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Evento</h2>
                <span class="close-modal" onclick="cerrarModal()">&times;</span>
            </div>
            <form onsubmit="crearEvento(event)">
                <div class="form-group">
                    <label>ID del Evento (sin espacios):</label>
                    <input type="text" id="nuevoEventoId" required placeholder="ej: sorteo-febrero-2026">
                </div>
                <div class="form-group">
                    <label>Nombre del Evento:</label>
                    <input type="text" id="nuevoEventoNombre" required placeholder="ej: Sorteo Febrero 2026">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Fecha Inicio:</label>
                        <input type="date" id="nuevoEventoFechaInicio" required>
                    </div>
                    <div class="form-group">
                        <label>Fecha Fin:</label>
                        <input type="date" id="nuevoEventoFechaFin" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Descripción:</label>
                    <textarea id="nuevoEventoDescripcion" rows="3" placeholder="Descripción del evento..."></textarea>
                </div>

                <div class="alert alert-info" style="font-size: 13px;">
                    El evento se creará <strong>desactivado</strong>. Podés activarlo luego desde la lista de
                    eventos.
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Crear Evento</button>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-db.min.js"></script>
    <script src="js/firebase-admin.min.js"></script>

    <script>
        // Inicializar Firebase PRIMERO
        firebase.initializeApp(window.FIREBASE_CONFIG);
        console.log('✅ Firebase inicializado');

        let eventosData = [];
        let registrosActuales = [];
        let eventoSeleccionadoId = null;

        // Al cargar la página - Verificar estado de autenticación de Firebase
        window.onload = function () {
            // Escuchar cambios en el estado de autenticación
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    // Usuario autenticado - Esperar a que el token esté listo
                    console.log('✅ Usuario autenticado:', user.email);

                    try {
                        // Asegurarse de que el token de autenticación esté disponible
                        await user.getIdToken();
                        console.log('✅ Token de autenticación obtenido');

                        // Ahora sí iniciar el panel
                        await iniciarPanel();
                    } catch (error) {
                        console.error('❌ Error obteniendo token:', error);
                        document.getElementById('loginScreen').style.display = 'block';
                        document.getElementById('adminPanel').style.display = 'none';
                    }
                } else {
                    // No hay usuario autenticado
                    console.log('ℹ️ No hay sesión activa');
                    document.getElementById('loginScreen').style.display = 'block';
                    document.getElementById('adminPanel').style.display = 'none';
                }
            });
        };

        // Login
        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (!email || !password) {
                errorDiv.textContent = 'Ingrese email y contraseña';
                setTimeout(() => errorDiv.textContent = '', 3000);
                return;
            }

            try {
                // Intentar login con Firebase Authentication
                // Firebase Auth maneja automáticamente la persistencia de sesión
                await loginWithFirebase(email, password);
                // El onAuthStateChanged detectará el login y llamará a iniciarPanel()
            } catch (error) {
                let mensaje = 'Error de autenticación';
                if (error.code === 'auth/user-not-found') {
                    mensaje = 'Usuario no encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    mensaje = 'Contraseña incorrecta';
                } else if (error.code === 'auth/invalid-email') {
                    mensaje = 'Email inválido';
                } else if (error.code === 'auth/too-many-requests') {
                    mensaje = 'Demasiados intentos. Espere un momento';
                }
                errorDiv.textContent = mensaje;
                setTimeout(() => errorDiv.textContent = '', 5000);
            }
        }

        // Iniciar panel
        async function iniciarPanel() {
            try {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';

                // Restricción de usuario conflu@casinomagic.com.ar
                const user = firebase.auth().currentUser;
                if (user && user.email === 'conflu@casinomagic.com.ar') {
                    const btnNuevo = document.getElementById('btnNuevoEvento');
                    if (btnNuevo) btnNuevo.style.display = 'none';
                }

                // Inicializar Firebase
                if (!FirebaseDB.initFirestore()) {
                    alert('Error conectando con Firebase');
                    return;
                }

                // Verificar y corregir eventos activos
                const eventoCorregido = await FirebaseAdmin.verificarYCorregirEventosActivos();
                if (eventoCorregido) {
                    console.log(`ℹ️ Se corrigió automáticamente: solo el evento "${eventoCorregido}" está activo`);
                }

                // Cargar datos
                await cargarEstadisticas();
                await cargarEventos();
            } catch (error) {
                console.error('❌ Error inicializando panel:', error);
                alert('Error al cargar el panel: ' + error.message);
                // Volver al login si hay error
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('adminPanel').style.display = 'none';
            }
        }

        // Cargar estadísticas
        async function cargarEstadisticas() {
            const statsGrid = document.getElementById('statsGrid');
            const eventos = await FirebaseAdmin.getAllEventos();

            let totalRegistros = 0;
            let eventosActivos = 0;

            for (const evento of eventos) {
                const stats = await FirebaseAdmin.getEstadisticasEvento(evento.id);
                totalRegistros += stats.total;
                if (evento.activo) eventosActivos++;
            }

            statsGrid.innerHTML = `
                <div class="stat-card" onclick="verTodosRegistros()" style="cursor: pointer;" title="Ver todos los registros">
                    <h3>Total Registros</h3>
                    <div class="number">${totalRegistros}</div>
                </div>
            `;
        }

        // Cargar eventos
        async function cargarEventos() {
            const listaDiv = document.getElementById('eventosLista');
            listaDiv.innerHTML = '<div class="spinner"></div>';

            eventosData = await FirebaseAdmin.getAllEventos();

            // Filtrar solo activos
            const eventosVisibles = eventosData.filter(e => e.activo);

            if (eventosVisibles.length === 0) {
                listaDiv.innerHTML = '<p>No hay eventos activos.</p>';
                return;
            }

            let html = '<div class="eventos-table-wrapper"><table class="eventos-table"><thead><tr><th>Evento</th><th>Período</th><th>Estado</th><th>Registros</th><th style="text-align: center;">Acciones</th></tr></thead><tbody>';

            for (const evento of eventosVisibles) {
                const stats = await FirebaseAdmin.getEstadisticasEvento(evento.id);
                const fechaInicio = evento.fechaInicio?.toDate ? evento.fechaInicio.toDate().toLocaleDateString('es-AR') : 'N/A';
                const fechaFin = evento.fechaFin?.toDate ? evento.fechaFin.toDate().toLocaleDateString('es-AR') : 'N/A';

                const estadoClass = evento.activo ? 'evento-activo' : 'evento-inactivo';
                // Removemos iconos también aquí si quedaban

                html += `
                    <tr class="${estadoClass}">
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <strong style="font-size: 15px; color: var(--primary);">${evento.nombre}</strong>
                                <small style="color: #666; margin-top: 3px;">ID: ${evento.id}</small>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 3px;">
                                <span>${fechaInicio}</span>
                                <span>${fechaFin}</span>
                            </div>
                        </td>
                        <td>
                            ${evento.activo ?
                        '<span class="badge badge-success" style="font-size: 13px;">ACTIVO</span>' :
                        '<span class="badge badge-danger" style="font-size: 13px;">INACTIVO</span>'}
                        </td>
                        <td>
                            <div style="text-align: center;">
                                <strong style="font-size: 20px; color: var(--primary);">${stats.total}</strong>
                                <div style="font-size: 11px; color: #666;">participantes</div>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                                <button class="btn btn-info" onclick="verRegistros('${evento.id}', '${evento.nombre}')" style="padding: 8px 15px; font-size: 13px;">
                                    Ver Registros
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            html += '</tbody></table></div>';
            listaDiv.innerHTML = html;
        }

        // Toggle evento activo/inactivo
        async function toggleEvento(eventoId, activo) {
            const user = firebase.auth().currentUser;
            if (user && user.email === 'conflu@casinomagic.com.ar') {
                alert('No tenés permisos para cambiar el estado de los eventos.');
                return;
            }
            try {
                // Si se va a activar este evento
                if (activo) {
                    // Buscar el evento activo actual
                    const eventoActivo = eventosData.find(e => e.activo && e.id !== eventoId);

                    if (eventoActivo) {
                        const confirmar = confirm(
                            `ATENCIÓN\n\n` +
                            `El evento "${eventoActivo.nombre}" está activo actualmente.\n\n` +
                            `¿Querés desactivarlo y activar "${eventosData.find(e => e.id === eventoId).nombre}"?`
                        );

                        if (!confirmar) {
                            return; // Cancelar si el usuario no confirma
                        }

                        // Desactivar el evento activo actual
                        await FirebaseAdmin.toggleEventoActivo(eventoActivo.id, false);
                    }
                }

                // Activar o desactivar el evento seleccionado
                await FirebaseAdmin.toggleEventoActivo(eventoId, activo);
                await cargarEstadisticas();
                await cargarEventos();

                const mensaje = activo ? 'Evento activado exitosamente' : 'Evento desactivado';
                alert(mensaje);
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Ver todos los registros
        async function verTodosRegistros() {
            eventoSeleccionadoId = 'todos';
            document.getElementById('eventoSeleccionadoNombre').textContent = 'Todos los Registros Históricos';
            document.getElementById('registrosSection').style.display = 'block';
            document.getElementById('registrosTabla').innerHTML = '<div class="spinner"></div>';

            // Scroll a la sección
            document.getElementById('registrosSection').scrollIntoView({ behavior: 'smooth' });

            let todosLosRegistros = [];

            try {
                if (!eventosData || eventosData.length === 0) {
                    eventosData = await FirebaseAdmin.getAllEventos();
                }

                // Recopilar registros de todos los eventos
                for (const evento of eventosData) {
                    const regs = await FirebaseAdmin.getAllRegistrosEvento(evento.id);
                    todosLosRegistros = todosLosRegistros.concat(regs);
                }

                registrosActuales = todosLosRegistros;
                mostrarRegistros(registrosActuales);
            } catch (error) {
                console.error('Error cargando todos los registros:', error);
                document.getElementById('registrosTabla').innerHTML = '<p style="color: red;">Error cargando registros: ' + error.message + '</p>';
            }
        }

        // Ver registros de un evento
        async function verRegistros(eventoId, nombreEvento) {
            eventoSeleccionadoId = eventoId;
            document.getElementById('eventoSeleccionadoNombre').textContent = nombreEvento;
            document.getElementById('registrosSection').style.display = 'block';
            document.getElementById('registrosTabla').innerHTML = '<div class="spinner"></div>';

            registrosActuales = await FirebaseAdmin.getAllRegistrosEvento(eventoId);
            mostrarRegistros(registrosActuales);
        }

        // Mostrar registros en tabla
        function mostrarRegistros(registros) {
            const tablaDiv = document.getElementById('registrosTabla');

            if (registros.length === 0) {
                tablaDiv.innerHTML = '<p>No hay registros en este evento.</p>';
                return;
            }

            let html = '<div style="overflow-x: auto;"><table><thead><tr><th>DNI</th><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Fecha Registro</th><th>Estado</th></tr></thead><tbody>';

            registros.forEach(r => {
                const fecha = r.timestamp ? new Date(r.timestamp).toLocaleString() : 'N/A';
                html += `
                    <tr>
                        <td><strong>${r.dni}</strong></td>
                        <td>${r.nombreCompleto}</td>
                        <td>${r.email || '-'}</td>
                        <td>${r.telefono || '-'}</td>
                        <td>${fecha}</td>
                        <td><span class="badge badge-success">${r.estado || 'ACTIVO'}</span></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            tablaDiv.innerHTML = html;
        }

        // Filtrar registros por DNI
        function filtrarRegistros() {
            const searchTerm = document.getElementById('searchDNI').value.toLowerCase();
            const filtrados = registrosActuales.filter(r => r.dni.includes(searchTerm));
            mostrarRegistros(filtrados);
        }

        // Cerrar vista de registros
        function cerrarRegistros() {
            document.getElementById('registrosSection').style.display = 'none';
            eventoSeleccionadoId = null;
        }

        // Exportar registros
        function exportarRegistrosActuales() {
            if (registrosActuales.length === 0) {
                alert('No hay registros para exportar');
                return;
            }
            const nombreEvento = document.getElementById('eventoSeleccionadoNombre').textContent;
            FirebaseAdmin.exportarCSV(registrosActuales, nombreEvento);
        }

        // Modal nuevo evento
        function mostrarModalNuevoEvento() {
            document.getElementById('modalNuevoEvento').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalNuevoEvento').style.display = 'none';
        }



        // Crear evento
        async function crearEvento(event) {
            event.preventDefault();

            const user = firebase.auth().currentUser;
            if (user && user.email === 'conflu@casinomagic.com.ar') {
                alert('No tenés permisos para crear eventos.');
                return;
            }

            const eventoId = document.getElementById('nuevoEventoId').value.trim().toLowerCase().replace(/\s+/g, '-');
            const nombre = document.getElementById('nuevoEventoNombre').value;
            const fechaInicio = new Date(document.getElementById('nuevoEventoFechaInicio').value);
            const fechaFin = new Date(document.getElementById('nuevoEventoFechaFin').value);
            const descripcion = document.getElementById('nuevoEventoDescripcion').value;

            try {
                // Siempre crear evento desactivado
                await FirebaseDB.createOrUpdateEvento(eventoId, {
                    nombre,
                    fechaInicio,
                    fechaFin,
                    descripcion,
                    activo: false
                });

                cerrarModal();

                // Limpiar formulario
                document.getElementById('nuevoEventoId').value = '';
                document.getElementById('nuevoEventoNombre').value = '';
                document.getElementById('nuevoEventoFechaInicio').value = '';
                document.getElementById('nuevoEventoFechaFin').value = '';
                document.getElementById('nuevoEventoDescripcion').value = '';

                await cargarEstadisticas();
                await cargarEventos();
                alert('Evento creado exitosamente\n\nEl evento está desactivado. Podés activarlo desde la lista de eventos.');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }


    </script>
</body>

</html>