const DEBUG_MODE=!1;function debugLog(...e){false}let currentDni=null,elements={},eventoActual=null,usingFirebase=!1;const SCREENS={DNI_CHECK:"dniScreen",REGISTRATION:"registrationScreen",ALREADY_REGISTERED:"alreadyRegisteredScreen"},DEVICE_INFO={isMobile:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0,isIOS:/iPad|iPhone|iPod/.test(navigator.userAgent),isAndroid:/Android/.test(navigator.userAgent),canCloseWindow:!1};function sanitizeInput(e){return"string"!=typeof e?e:e.trim().replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").replace(/&lt;/g,"").replace(/&gt;/g,"").replace(/&#/g,"").replace(/eval\(/gi,"").replace(/expression\(/gi,"").slice(0,500)}function sanitizeName(e){return"string"!=typeof e?"":e.trim().replace(/[<>]/g,"").replace(/[0-9]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").replace(/[^\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/g,"").replace(/\s+/g," ").slice(0,100)}function sanitizeEmail(e){return"string"!=typeof e?"":e.trim().toLowerCase().replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").replace(/\s/g,"").slice(0,100)}function sanitizePhone(e){return"string"!=typeof e?"":e.trim().replace(/[^\d\-\s]/g,"").replace(/\s+/g,"").slice(0,20)}async function initializeFirebase(){try{if(window.FirebaseDB&&FirebaseDB.initFirestore()){debugLog("‚úÖ Firebase inicializado"),usingFirebase=!0;const e=await FirebaseDB.getEventoActivo();if(e){eventoActual=e,FirebaseDB.setEventoActual(e.id),debugLog("‚úÖ Evento activo:",e.nombre);const t=document.getElementById("eventoNombre");t&&(t.textContent=`üéØ ${e.nombre}`,t.style.color="#161337",t.style.fontWeight="600")}else{console.warn("‚ö†Ô∏è No hay eventos activos"),eventoActual={id:"evento-default",nombre:"Evento Principal"},FirebaseDB.setEventoActual("evento-default");const e=document.getElementById("eventoNombre");e&&(e.textContent="üéØ Evento Principal",e.style.color="#666")}}else{console.warn("‚ö†Ô∏è Firebase no disponible, usando fallback"),usingFirebase=!1;const e=document.getElementById("eventoNombre");e&&(e.style.display="none")}}catch(e){console.error("‚ùå Error inicializando Firebase:",e),usingFirebase=!1;const t=document.getElementById("eventoNombre");t&&(t.textContent="",t.style.display="none")}}function initializeElements(){elements={dniInput:document.getElementById("dniInput"),checkDniBtn:document.getElementById("checkDniBtn"),displayDni:document.getElementById("displayDni"),registrationForm:document.getElementById("registrationForm"),nombreCompletoInput:document.getElementById("nombreCompletoInput"),fechaNacimientoInput:document.getElementById("fechaNacimientoInput"),emailInput:document.getElementById("emailInput"),telefonoInput:document.getElementById("telefonoInput"),participantConfirms:document.getElementById("participantConfirms"),submitBtn:document.getElementById("submitBtn"),backBtn:document.getElementById("backBtn"),existingParticipantName:document.getElementById("existingParticipantName"),existingParticipantDni:document.getElementById("existingParticipantDni"),backToStartBtn:document.getElementById("backToStartBtn"),message:document.getElementById("message")}}function showScreen(e){Object.values(SCREENS).forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")});const t=document.getElementById(e);t&&(t.style.display="block"),document.body.classList.toggle("hide-header",e!==SCREENS.DNI_CHECK),clearMessage()}function goToRegistrationForm(e){currentDni=e,elements.displayDni.textContent=e,showScreen(SCREENS.REGISTRATION),setTimeout(()=>elements.nombreCompletoInput?.focus(),100)}function goToAlreadyRegistered(e){elements.existingParticipantName.textContent=e.nombre||e.nombreCompleto||"",elements.existingParticipantDni.textContent=`DNI: ${e.dni}`,showScreen(SCREENS.ALREADY_REGISTERED)}function goBackToDniCheck(){elements.registrationForm?.reset(),elements.dniInput&&(elements.dniInput.value=""),currentDni=null,showScreen(SCREENS.DNI_CHECK),setTimeout(()=>elements.dniInput?.focus(),100)}function setupEventListeners(){elements.dniInput?.addEventListener("input",e=>{e.target.value=e.target.value.replace(/\D/g,"").slice(0,8)}),elements.dniInput?.addEventListener("keypress",e=>{"Enter"===e.key&&handleCheckDni()}),elements.checkDniBtn?.addEventListener("click",handleCheckDni),elements.registrationForm?.addEventListener("submit",handleRegistrationSubmit),elements.backBtn?.addEventListener("click",goBackToDniCheck),elements.backToStartBtn?.addEventListener("click",goBackToDniCheck)}async function handleCheckDni(){const e=elements.dniInput?.value?.trim();validateDniArgentino(e)?(elements.checkDniBtn.disabled=!0,elements.checkDniBtn.textContent="VALIDANDO...",setTimeout(()=>{elements.checkDniBtn.disabled=!1,elements.checkDniBtn.textContent="CONTINUAR",goToRegistrationForm(e)},500)):showMessage("Ingres√° un DNI argentino v√°lido (7-8 n√∫meros).","error")}async function handleRegistrationSubmit(e){if(e.preventDefault(),!validatePersonalData())return;const t=elements.nombreCompletoInput.value,n=elements.emailInput.value,o=elements.telefonoInput.value;debugLog("üìù Datos a enviar - nombreCompleto:",t);const i={dni:currentDni,nombreCompleto:t,fechaNacimiento:elements.fechaNacimientoInput.value,email:n,telefono:o,confirma:elements.participantConfirms.checked};elements.submitBtn.disabled=!0,elements.submitBtn.textContent="REGISTRANDO...",showLoadingModal("Verificando tu DNI...","Validando que no est√© registrado previamente.","verifying");try{await new Promise(e=>setTimeout(e,800)),updateLoadingModal("Procesando registro...","Guardando tu informaci√≥n en el sistema.","processing");const e=await sendRegistration(i);if(debugLog("üîç Respuesta del servidor:",e),debugLog("üîç Respuesta completa:",JSON.stringify(e,null,2)),hideLoadingModal(),e.success||"SUCCESS"===e.status)debugLog("‚úÖ Registro exitoso"),clearMessage(),showSuccessMessage(t);else if("DUPLICATE"===e.status){debugLog("‚ö†Ô∏è DNI duplicado"),showMessage("Este DNI ya est√° registrado. Record√° que el ganador debe estar presente en el evento.","warning");goToAlreadyRegistered(e.data||e.existingData||{dni:currentDni,nombreCompleto:"Participante",nombre:"Participante"})}else debugLog("‚ùå Error en registro:",e),showMessage(e.message||"Error al procesar el registro.","error")}catch(e){debugLog("‚ùå Error de conexi√≥n:",e),updateLoadingModal("Error de conexi√≥n","No se pudo conectar con el servidor.","error"),await new Promise(e=>setTimeout(e,1500)),hideLoadingModal(),showMessage("Error al procesar. Intent√° nuevamente.","error")}finally{elements.submitBtn.disabled=!1,elements.submitBtn.textContent="REGISTRARSE"}}function validateDniArgentino(e){if(!e||!/^\d{7,8}$/.test(e))return!1;const t=parseInt(e);return!(t<1e6||t>99999999)&&(!(t<3e6)&&!/^(\d)\1+$/.test(e))}function validateAge(e){if(!e)return{valid:!1,message:"Ingres√° tu fecha de nacimiento."};const t=new Date(e),n=new Date;let o=n.getFullYear()-t.getFullYear();const i=n.getMonth()-t.getMonth();return(i<0||0===i&&n.getDate()<t.getDate())&&o--,o<18?{valid:!1,message:"Deb√©s ser mayor de 18 a√±os para participar."}:t>n?{valid:!1,message:"La fecha de nacimiento no puede ser futura."}:o>120?{valid:!1,message:"Por favor verific√° la fecha de nacimiento ingresada."}:{valid:!0,age:o}}function validatePersonalData(){const e=[{element:elements.nombreCompletoInput,message:"Ingres√° tu nombre y apellido."},{element:elements.fechaNacimientoInput,message:"Ingres√° tu fecha de nacimiento."},{element:elements.emailInput,message:"Ingres√° un email v√°lido."},{element:elements.telefonoInput,message:"Ingres√° tu tel√©fono."}];for(const t of e)if(!t.element?.value?.trim())return showMessage(t.message,"error"),t.element?.focus(),!1;if(elements.nombreCompletoInput.value.trim().split(" ").filter(e=>e.length>0).length<2)return showMessage("Ingres√° tu nombre y apellido completos.","error"),elements.nombreCompletoInput.focus(),!1;if(!validateEmail(elements.emailInput.value))return showMessage("Ingres√° un email v√°lido.","error"),elements.emailInput.focus(),!1;const t=validateAge(elements.fechaNacimientoInput.value);return t.valid?!!elements.participantConfirms?.checked||(showMessage("Deb√©s confirmar tu participaci√≥n.","error"),!1):(showMessage(t.message,"error"),elements.fechaNacimientoInput.focus(),!1)}function validateEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}async function makeRequest(e,t=5e3){return new Promise((n,o)=>{const i=e.match(/callback=([^&]+)/);if(!i)return void o(new Error("No se encontr√≥ callback en la URL"));const s=i[1],a=document.createElement("script");debugLog("üîó Creando callback:",s);const r=()=>{a.parentNode&&document.head.removeChild(a),delete window[s]};window[s]=function(e){debugLog("‚úÖ Callback ejecutado:",s,e),r(),n(e)},a.onerror=()=>{console.error("‚ùå Error cargando script:",e),r(),o(new Error("Error de red"))},a.src=e,document.head.appendChild(a),setTimeout(()=>{window[s]&&(console.error("‚è∞ Timeout en callback:",s),r(),o(new Error("Timeout")))},t)})}async function sendRegistration(e,t=2){if(usingFirebase&&window.FirebaseDB)try{debugLog("üî• Registrando con Firebase...");const t=await FirebaseDB.createRegistro({dni:e.dni,nombreCompleto:e.nombreCompleto,fechaNacimiento:e.fechaNacimiento,email:e.email,telefono:e.telefono,fechaEvento:e.fechaEvento,horaEvento:e.horaEvento,ipAddress:e.ipAddress||"0.0.0.0"});return debugLog("üìã Resultado Firebase:",t),t}catch(e){throw console.error("‚ùå Error con Firebase:",e),e}return console.warn("‚ö†Ô∏è Usando fallback a Google Sheets"),await sendRegistrationToGoogleSheets(e,t)}async function sendRegistrationToGoogleSheets(e,t=2){const n=window.APP_CONFIG||{apiUrl:"https://script.google.com/macros/s/AKfycbwf-1NsI6gyUqR9_Bk_N5B06R9CiY05Rfn9K2xHao7UfZJS2e3OLlmAqONzBc9noo4A/exec"};for(let o=0;o<=t;o++)try{const t="callback_"+Date.now(),o={action:"registrar",...e},i=new URLSearchParams(o),s=`${n.apiUrl}?${i}&callback=${t}`;return await makeRequest(s,15e3)}catch(e){if(console.error("‚ùå Error en intento",o+1,":",e),o===t)throw e;await new Promise(e=>setTimeout(e,1e3))}}function showMessage(e,t="info"){elements.message&&(elements.message.textContent=e,elements.message.className=`message ${t}`,elements.message.style.display="block")}function clearMessage(){elements.message&&(elements.message.style.display="none")}function showSuccessMessage(e){debugLog("üéâ Mostrando modal de √©xito para:",e),document.body.classList.add("hide-header");const t=document.createElement("div");t.className="success-final-screen",t.innerHTML=`\n        <div class="success-content">\n            <div class="success-icon">\n                <div class="checkmark-container">\n                    <div class="checkmark">‚úì</div>\n                </div>\n            </div>\n            <h2>Registro Exitoso</h2>\n            <div class="success-details">\n                <p><strong>${e}</strong></p>\n                <p>Tu registro ha sido completado correctamente.<br>Record√° que el ganador debe estar presente en el evento.</p>\n            </div>\n            <div class="success-actions">\n                <button type="button" class="btn btn-success-primary" id="closeSuccessBtn">FINALIZAR</button>\n                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">\n                    ¬°Registro completado! Al hacer clic se cerrar√° la ventana o ser√°s redirigido.\n                </p>\n            </div>\n        </div>\n    `,document.body.appendChild(t),t.querySelector("#closeSuccessBtn").addEventListener("click",()=>{debugLog("üéØ Bot√≥n FINALIZAR presionado"),debugLog("üì± Dispositivo m√≥vil:",DEVICE_INFO.isMobile);t.querySelector(".success-content").innerHTML='\n            <div class="success-icon">\n                <div class="checkmark-container">\n                    <div class="checkmark">‚úì</div>\n                </div>\n            </div>\n            <h2>¬°Gracias por participar!</h2>\n            <div class="success-details">\n                <p>Redirigiendo...</p>\n                <div class="loading-spinner" style="\n                    width: 30px; \n                    height: 30px; \n                    border: 3px solid #f3f3f3; \n                    border-top: 3px solid #28a745; \n                    border-radius: 50%; \n                    animation: spin 1s linear infinite;\n                    margin: 15px auto;\n                "></div>\n            </div>\n        ';try{window.close&&(window.close(),debugLog("üö™ window.close() ejecutado"))}catch(e){debugLog("‚ùå window.close() fall√≥:",e.message)}setTimeout(()=>{document.hidden||(debugLog("üåê No se pudo cerrar la ventana - redirigiendo a Casino Magic"),window.location.href="https://casinomagic.com.ar/")},1500)}),setTimeout(()=>{t.querySelector("#closeSuccessBtn").focus()},500)}function showLoadingModal(e="Verificando datos...",t="Por favor espera mientras procesamos tu informaci√≥n",n="verifying"){const o=document.getElementById("loadingModal"),i=document.getElementById("loadingTitle"),s=document.getElementById("loadingMessage"),a=o?.querySelector(".loading-content");o&&i&&s&&a&&(i.textContent=e,s.textContent=t,a.classList.remove("verifying","processing","error"),a.classList.add(n),o.style.display="flex",document.body.style.overflow="hidden",debugLog("üîÑ Modal de carga mostrado:",e,`(${n})`))}function hideLoadingModal(){const e=document.getElementById("loadingModal");e&&(e.style.display="none",document.body.style.overflow="",debugLog("‚úÖ Modal de carga oculto"))}function updateLoadingModal(e,t,n="processing"){const o=document.getElementById("loadingTitle"),i=document.getElementById("loadingMessage"),s=document.getElementById("loadingModal"),a=s?.querySelector(".loading-content");o&&i&&a&&(o.style.opacity="0.5",i.style.opacity="0.5",setTimeout(()=>{o.textContent=e,i.textContent=t,a.classList.remove("verifying","processing","error"),a.classList.add(n),o.style.opacity="1",i.style.opacity="1"},150),debugLog("üîÑ Modal de carga actualizado:",e,`(${n})`))}document.addEventListener("DOMContentLoaded",function(){initializeElements(),initializeFirebase(),setupEventListeners(),showScreen(SCREENS.DNI_CHECK),elements.dniInput?.focus()});