 function debugLog(...args){ if(typeof DEBUG_MODE!=='undefined'&&DEBUG_MODE)console.log(...args);}let currentDni=null;let elements ={};let eventoActual=null;let usingFirebase=false;const SCREENS ={ DNI_CHECK: 'dniScreen',REGISTRATION: 'registrationScreen',ALREADY_REGISTERED: 'alreadyRegisteredScreen' };const DEVICE_INFO ={ isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),hasTouch: 'ontouchstart' in window||navigator.maxTouchPoints > 0,isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent),isAndroid: /Android/.test(navigator.userAgent),canCloseWindow: false };function sanitizeInput(input){ if(typeof input!=='string')return input;return input .trim().replace(/[<>]/g,'').replace(/javascript:/gi,'').replace(/on\w+=/gi,'').replace(/&lt;/g,'').replace(/&gt;/g,'').replace(/&#/g,'').replace(/eval\(/gi,'').replace(/expression\(/gi,'').slice(0,500);}function sanitizeName(name){ if(typeof name!=='string')return '';return name .trim().replace(/[<>]/g,'').replace(/[0-9]/g,'').replace(/javascript:/gi,'').replace(/on\w+=/gi,'').replace(/[^\w\s√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë]/g,'').replace(/\s+/g,' ').slice(0,100);}function sanitizeEmail(email){ if(typeof email!=='string')return '';return email .trim().toLowerCase().replace(/[<>]/g,'').replace(/javascript:/gi,'').replace(/on\w+=/gi,'').replace(/\s/g,'').slice(0,100);}function sanitizePhone(phone){ if(typeof phone!=='string')return '';return phone .trim().replace(/[^\d\-\s]/g,'').replace(/\s+/g,'').slice(0,20);}document.addEventListener('DOMContentLoaded',function(){ initializeElements();initializeFirebase();setupEventListeners();showScreen(SCREENS.DNI_CHECK);elements.dniInput?.focus();});async function initializeFirebase(){ try{ if(window.FirebaseDB&&FirebaseDB.initFirestore()){ debugLog('‚úÖ Firebase inicializado');usingFirebase=true;const evento=await FirebaseDB.getEventoActivo();if(evento){ eventoActual=evento;FirebaseDB.setEventoActual(evento.id);debugLog('‚úÖ Evento activo:',evento.nombre);const eventoNombreElement=document.getElementById('eventoNombre');if(eventoNombreElement){ eventoNombreElement.textContent=`üéØ ${evento.nombre}`;eventoNombreElement.style.color='#161337';eventoNombreElement.style.fontWeight='600';}}else{ console.warn('‚ö†Ô∏è No hay eventos activos');eventoActual ={ id: 'evento-default',nombre: 'Evento Principal' };FirebaseDB.setEventoActual('evento-default');const eventoNombreElement=document.getElementById('eventoNombre');if(eventoNombreElement){ eventoNombreElement.textContent='üéØ Evento Principal';eventoNombreElement.style.color='#666';}}}else{ console.warn('‚ö†Ô∏è Firebase no disponible,usando fallback');usingFirebase=false;const eventoNombreElement=document.getElementById('eventoNombre');if(eventoNombreElement){ eventoNombreElement.style.display='none';}}}catch(error){ console.error('‚ùå Error inicializando Firebase:',error);usingFirebase=false;const eventoNombreElement=document.getElementById('eventoNombre');if(eventoNombreElement){ eventoNombreElement.textContent='';eventoNombreElement.style.display='none';}}}function initializeElements(){ elements ={ dniInput: document.getElementById('dniInput'),checkDniBtn: document.getElementById('checkDniBtn'),displayDni: document.getElementById('displayDni'),registrationForm: document.getElementById('registrationForm'),nombreCompletoInput: document.getElementById('nombreCompletoInput'),fechaNacimientoInput: document.getElementById('fechaNacimientoInput'),emailInput: document.getElementById('emailInput'),telefonoInput: document.getElementById('telefonoInput'),participantConfirms: document.getElementById('participantConfirms'),submitBtn: document.getElementById('submitBtn'),backBtn: document.getElementById('backBtn'),existingParticipantName: document.getElementById('existingParticipantName'),existingParticipantDni: document.getElementById('existingParticipantDni'),backToStartBtn: document.getElementById('backToStartBtn'),message: document.getElementById('message')};}function showScreen(screenName){ Object.values(SCREENS).forEach(screen =>{ const element=document.getElementById(screen);if(element)element.style.display='none';});const targetScreen=document.getElementById(screenName);if(targetScreen)targetScreen.style.display='block';document.body.classList.toggle('hide-header',screenName!==SCREENS.DNI_CHECK);clearMessage();}function goToRegistrationForm(dni){ currentDni=dni;elements.displayDni.textContent=dni;showScreen(SCREENS.REGISTRATION);setTimeout(()=> elements.nombreCompletoInput?.focus(),100);}function goToAlreadyRegistered(data){ elements.existingParticipantName.textContent=data.nombre||data.nombreCompleto||'';elements.existingParticipantDni.textContent=`DNI: ${data.dni}`;showScreen(SCREENS.ALREADY_REGISTERED);}function goBackToDniCheck(){ elements.registrationForm?.reset();if(elements.dniInput)elements.dniInput.value='';currentDni=null;showScreen(SCREENS.DNI_CHECK);setTimeout(()=> elements.dniInput?.focus(),100);}function setupEventListeners(){ elements.dniInput?.addEventListener('input',(e)=>{ e.target.value=e.target.value.replace(/\D/g,'').slice(0,8);});elements.dniInput?.addEventListener('keypress',(e)=>{ if(e.key==='Enter')handleCheckDni();});elements.checkDniBtn?.addEventListener('click',handleCheckDni);elements.registrationForm?.addEventListener('submit',handleRegistrationSubmit);elements.backBtn?.addEventListener('click',goBackToDniCheck);elements.backToStartBtn?.addEventListener('click',goBackToDniCheck);}async function handleCheckDni(){ const dni=elements.dniInput?.value?.trim();if(!validateDniArgentino(dni)){ showMessage('Ingres√° un DNI argentino v√°lido(7-8 n√∫meros).','error');return;}elements.checkDniBtn.disabled=true;elements.checkDniBtn.textContent='VALIDANDO...';setTimeout(()=>{ elements.checkDniBtn.disabled=false;elements.checkDniBtn.textContent='CONTINUAR';goToRegistrationForm(dni);},500);}async function handleRegistrationSubmit(event){ event.preventDefault();if(!validatePersonalData())return;const nombreCompleto=elements.nombreCompletoInput.value;const email=elements.emailInput.value;const telefono=elements.telefonoInput.value;debugLog('üìù Datos a enviar - nombreCompleto:',nombreCompleto);const data ={ dni: currentDni,nombreCompleto: nombreCompleto,fechaNacimiento: elements.fechaNacimientoInput.value,email: email,telefono: telefono,confirma: elements.participantConfirms.checked };elements.submitBtn.disabled=true;elements.submitBtn.textContent='REGISTRANDO...';showLoadingModal('Verificando tu DNI...','Validando que no est√© registrado previamente.','verifying');try{ await new Promise(resolve => setTimeout(resolve,800));updateLoadingModal('Procesando registro...','Guardando tu informaci√≥n en el sistema.','processing');const response=await sendRegistration(data);debugLog('üîç Respuesta del servidor:',response);debugLog('üîç Respuesta completa:',JSON.stringify(response,null,2));hideLoadingModal();if(response.success||response.status==='SUCCESS'){ debugLog('‚úÖ Registro exitoso');clearMessage();showSuccessMessage(nombreCompleto);}else if(response.status==='DUPLICATE'){ debugLog('‚ö†Ô∏è DNI duplicado');showMessage('Este DNI ya est√° registrado. Record√° que el ganador debe estar presente en el evento.','warning');const existingData=response.data||response.existingData ||{ dni: currentDni,nombreCompleto: 'Participante',nombre: 'Participante' };goToAlreadyRegistered(existingData);}else{ debugLog('‚ùå Error en registro:',response);showMessage(response.message||'Error al procesar el registro.','error');}}catch(error){ debugLog('‚ùå Error de conexi√≥n:',error);updateLoadingModal('Error de conexi√≥n','No se pudo conectar con el servidor.','error');await new Promise(resolve => setTimeout(resolve,1500));hideLoadingModal();showMessage('Error al procesar. Intent√° nuevamente.','error');}finally{ elements.submitBtn.disabled=false;elements.submitBtn.textContent='REGISTRARSE';}}function validateDniArgentino(dni){ if(!dni||!/^\d{7,8}$/.test(dni))return false;const dniNum=parseInt(dni);if(dniNum < 1000000||dniNum > 99999999)return false;if(dniNum < 3000000)return false;if(/^(\d)\1+$/.test(dni))return false;return true;}function validateAge(fechaNacimiento){ if(!fechaNacimiento){ return{ valid: false,message: 'Ingres√° tu fecha de nacimiento.' };}const birthDate=new Date(fechaNacimiento);const today=new Date();let age=today.getFullYear()- birthDate.getFullYear();const monthDiff=today.getMonth()- birthDate.getMonth();if(monthDiff < 0 ||(monthDiff===0&&today.getDate()< birthDate.getDate())){ age--;}if(age < 18){ return{ valid: false,message: 'Deb√©s ser mayor de 18 a√±os para participar.' };}if(birthDate > today){ return{ valid: false,message: 'La fecha de nacimiento no puede ser futura.' };}if(age > 120){ return{ valid: false,message: 'Por favor verific√° la fecha de nacimiento ingresada.' };}return{ valid: true,age: age };}function validatePersonalData(){ const fields=[{ element: elements.nombreCompletoInput,message: 'Ingres√° tu nombre y apellido.' },{ element: elements.fechaNacimientoInput,message: 'Ingres√° tu fecha de nacimiento.' },{ element: elements.emailInput,message: 'Ingres√° un email v√°lido.' },{ element: elements.telefonoInput,message: 'Ingres√° tu tel√©fono.' }];for(const field of fields){ if(!field.element?.value?.trim()){ showMessage(field.message,'error');field.element?.focus();return false;}}const nombreCompleto=elements.nombreCompletoInput.value.trim();if(nombreCompleto.split(' ').filter(word => word.length > 0).length < 2){ showMessage('Ingres√° tu nombre y apellido completos.','error');elements.nombreCompletoInput.focus();return false;}if(!validateEmail(elements.emailInput.value)){ showMessage('Ingres√° un email v√°lido.','error');elements.emailInput.focus();return false;}const ageValidation=validateAge(elements.fechaNacimientoInput.value);if(!ageValidation.valid){ showMessage(ageValidation.message,'error');elements.fechaNacimientoInput.focus();return false;}if(!elements.participantConfirms?.checked){ showMessage('Deb√©s confirmar tu participaci√≥n.','error');return false;}return true;}function validateEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);}async function makeRequest(url,timeout=5000){ return new Promise((resolve,reject)=>{ const callbackMatch=url.match(/callback=([^&]+)/);if(!callbackMatch){ reject(new Error('No se encontr√≥ callback en la URL'));return;}const callbackName=callbackMatch[1];const script=document.createElement('script');debugLog('üîó Creando callback:',callbackName);const cleanup =()=>{ if(script.parentNode){ document.head.removeChild(script);}delete window[callbackName];};window[callbackName]=function(response){ debugLog('‚úÖ Callback ejecutado:',callbackName,response);cleanup();resolve(response);};script.onerror =()=>{ console.error('‚ùå Error cargando script:',url);cleanup();reject(new Error('Error de red'));};script.src=url;document.head.appendChild(script);setTimeout(()=>{ if(window[callbackName]){ console.error('‚è∞ Timeout en callback:',callbackName);cleanup();reject(new Error('Timeout'));}},timeout);});}async function sendRegistration(data,retries=2){ if(usingFirebase&&window.FirebaseDB){ try{ debugLog('üî• Registrando con Firebase...');const resultado=await FirebaseDB.createRegistro({ dni: data.dni,nombreCompleto: data.nombreCompleto,fechaNacimiento: data.fechaNacimiento,email: data.email,telefono: data.telefono,fechaEvento: data.fechaEvento,horaEvento: data.horaEvento,ipAddress: data.ipAddress||'0.0.0.0' });debugLog('üìã Resultado Firebase:',resultado);return resultado;}catch(error){ console.error('‚ùå Error con Firebase:',error);throw error;}}console.warn('‚ö†Ô∏è Usando fallback a Google Sheets');return await sendRegistrationToGoogleSheets(data,retries);}async function sendRegistrationToGoogleSheets(data,retries=2){ const CONFIG=window.APP_CONFIG ||{ apiUrl: 'https: };for(let attempt=0;attempt <= retries;attempt++){ try{ const callbackName='callback_' + Date.now();const requestData ={ action: 'registrar',...data };const params=new URLSearchParams(requestData);const url=`${CONFIG.apiUrl}?${params}&callback=${callbackName}`;return await makeRequest(url,15000);}catch(error){ console.error('‚ùå Error en intento',attempt + 1,':',error);if(attempt===retries)throw error;await new Promise(resolve => setTimeout(resolve,1000));}}}function showMessage(message,type='info'){ if(elements.message){ elements.message.textContent=message;elements.message.className=`message ${type}`;elements.message.style.display='block';}}function clearMessage(){ if(elements.message){ elements.message.style.display='none';}}function showSuccessMessage(nombreCompleto){ debugLog('üéâ Mostrando modal de √©xito para:',nombreCompleto);document.body.classList.add('hide-header');const successModal=document.createElement('div');successModal.className='success-final-screen';successModal.innerHTML=` <div class="success-content"> <div class="success-icon"> <div class="checkmark-container"> <div class="checkmark">‚úì</div> </div> </div> <h2>Registro Exitoso</h2> <div class="success-details"> <p><strong>${nombreCompleto}</strong></p> <p>Tu registro ha sido completado correctamente.<br>Record√° que el ganador debe estar presente en el evento.</p> </div> <div class="success-actions"> <button type="button" class="btn btn-success-primary" id="closeSuccessBtn">FINALIZAR</button> <p style="margin-top: 10px;font-size: 0.9em;color: #666;"> ¬°Registro completado! Al hacer clic se cerrar√° la ventana o ser√°s redirigido. </p> </div> </div> `;document.body.appendChild(successModal);successModal.querySelector('#closeSuccessBtn').addEventListener('click',()=>{ debugLog('üéØ Bot√≥n FINALIZAR presionado');debugLog('üì± Dispositivo m√≥vil:',DEVICE_INFO.isMobile);const modalContent=successModal.querySelector('.success-content');modalContent.innerHTML=` <div class="success-icon"> <div class="checkmark-container"> <div class="checkmark">‚úì</div> </div> </div> <h2>¬°Gracias por participar!</h2> <div class="success-details"> <p>Redirigiendo...</p> <div class="loading-spinner" style=" width: 30px;height: 30px;border: 3px solid #f3f3f3;border-top: 3px solid #28a745;border-radius: 50%;animation: spin 1s linear infinite;margin: 15px auto;"></div> </div> `;try{ if(window.close){ window.close();debugLog('üö™ window.close()ejecutado');}}catch(e){ debugLog('‚ùå window.close()fall√≥:',e.message);}setTimeout(()=>{ if(!document.hidden){ debugLog('üåê No se pudo cerrar la ventana - redirigiendo a Casino Magic');window.location.href='https: }},1500);});setTimeout(()=>{ successModal.querySelector('#closeSuccessBtn').focus();},500);}function showLoadingModal(title='Verificando datos...',message='Por favor espera mientras procesamos tu informaci√≥n',state='verifying'){ const loadingModal=document.getElementById('loadingModal');const loadingTitle=document.getElementById('loadingTitle');const loadingMessage=document.getElementById('loadingMessage');const loadingContent=loadingModal?.querySelector('.loading-content');if(loadingModal&&loadingTitle&&loadingMessage&&loadingContent){ loadingTitle.textContent=title;loadingMessage.textContent=message;loadingContent.classList.remove('verifying','processing','error');loadingContent.classList.add(state);loadingModal.style.display='flex';document.body.style.overflow='hidden';debugLog('üîÑ Modal de carga mostrado:',title,`(${state})`);}}function hideLoadingModal(){ const loadingModal=document.getElementById('loadingModal');if(loadingModal){ loadingModal.style.display='none';document.body.style.overflow='';debugLog('‚úÖ Modal de carga oculto');}}function updateLoadingModal(title,message,state='processing'){ const loadingTitle=document.getElementById('loadingTitle');const loadingMessage=document.getElementById('loadingMessage');const loadingModal=document.getElementById('loadingModal');const loadingContent=loadingModal?.querySelector('.loading-content');if(loadingTitle&&loadingMessage&&loadingContent){ loadingTitle.style.opacity='0.5';loadingMessage.style.opacity='0.5';setTimeout(()=>{ loadingTitle.textContent=title;loadingMessage.textContent=message;loadingContent.classList.remove('verifying','processing','error');loadingContent.classList.add(state);loadingTitle.style.opacity='1';loadingMessage.style.opacity='1';},150);debugLog('üîÑ Modal de carga actualizado:',title,`(${state})`);}}