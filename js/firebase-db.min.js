const DEBUG_MODE=!1;function debugLog(...e){false}const CACHE_CONFIG={EVENTO_ACTIVO_TTL:18e5,ENABLE_CACHE:!0,STORAGE_KEY_EVENTO:"cmn_evento_activo",STORAGE_KEY_TIMESTAMP:"cmn_evento_timestamp"};let db=null,currentEventoId=null;function initFirestore(){if(!window.FIREBASE_CONFIG)return console.error("‚ùå Firebase config no encontrada"),!1;try{return firebase.apps.length||firebase.initializeApp(window.FIREBASE_CONFIG),db=firebase.firestore(),debugLog("‚úÖ Firestore inicializado correctamente"),!0}catch(e){return console.error("‚ùå Error inicializando Firestore:",e),!1}}function setEventoActual(e){currentEventoId=e,debugLog("üìÖ Evento actual:",e)}function getEventoActual(){return currentEventoId||"evento-default"}async function checkDniExists(e){try{const t=getEventoActual(),o=db.collection("eventos").doc(t).collection("registros").doc(e),r=await o.get();return r.exists?{exists:!0,data:r.data()}:{exists:!1,data:null}}catch(e){throw console.error("‚ùå Error verificando DNI:",e),e}}async function createRegistro(e){try{const t=getEventoActual(),o=e.dni,r=await checkDniExists(o);if(r.exists)return{status:"DUPLICATE",message:"Este DNI ya est√° registrado en este evento",data:r.data};const n=db.collection("eventos").doc(t).collection("registros").doc(o),c={...e,eventoId:t,timestamp:firebase.firestore.FieldValue.serverTimestamp(),estado:"ACTIVO",syncedToSheets:!1};return await n.set(c),debugLog("‚úÖ Registro creado:",o),{status:"SUCCESS",message:"Registro creado exitosamente",data:c}}catch(e){return console.error("‚ùå Error creando registro:",e),{status:"ERROR",message:"Error al crear el registro: "+e.message,error:e}}}async function getRegistros(e=100){try{const t=getEventoActual(),o=await db.collection("eventos").doc(t).collection("registros").orderBy("timestamp","desc").limit(e).get(),r=[];return o.forEach(e=>{r.push({id:e.id,...e.data()})}),r}catch(e){throw console.error("‚ùå Error obteniendo registros:",e),e}}async function getPendientesSincronizacion(){try{const e=getEventoActual(),t=await db.collection("eventos").doc(e).collection("registros").where("syncedToSheets","==",!1).orderBy("timestamp","asc").get(),o=[];return t.forEach(e=>{o.push({id:e.id,...e.data()})}),o}catch(e){throw console.error("‚ùå Error obteniendo pendientes:",e),e}}async function markAsSynced(e){try{const t=getEventoActual(),o=db.collection("eventos").doc(t).collection("registros").doc(e);await o.update({syncedToSheets:!0}),debugLog("‚úÖ Registro marcado como sincronizado:",e)}catch(e){throw console.error("‚ùå Error marcando como sincronizado:",e),e}}async function createOrUpdateEvento(e,t){try{const o=db.collection("eventos").doc(e);await o.set({...t,actualizadoEn:firebase.firestore.FieldValue.serverTimestamp()},{merge:!0}),debugLog("‚úÖ Evento creado/actualizado:",e)}catch(e){throw console.error("‚ùå Error creando/actualizando evento:",e),e}}async function getEventoActivo(){try{if(CACHE_CONFIG.ENABLE_CACHE){const e=localStorage.getItem(CACHE_CONFIG.STORAGE_KEY_EVENTO),t=parseInt(localStorage.getItem(CACHE_CONFIG.STORAGE_KEY_TIMESTAMP)||"0"),o=Date.now();if(e&&o-t<CACHE_CONFIG.EVENTO_ACTIVO_TTL)return debugLog("üì¶ Cache HIT - Evento activo desde localStorage"),JSON.parse(e);debugLog("üîÑ Cache MISS - Consultando Firestore")}const e=await db.collection("eventos").where("activo","==",!0).limit(1).get();if(!e.empty){const t=e.docs[0],o={id:t.id,...t.data()};return CACHE_CONFIG.ENABLE_CACHE&&(localStorage.setItem(CACHE_CONFIG.STORAGE_KEY_EVENTO,JSON.stringify(o)),localStorage.setItem(CACHE_CONFIG.STORAGE_KEY_TIMESTAMP,Date.now().toString()),debugLog("üíæ Evento guardado en cache")),o}return null}catch(e){throw console.error("‚ùå Error obteniendo evento activo:",e),e}}function clearEventoCache(){localStorage.removeItem(CACHE_CONFIG.STORAGE_KEY_EVENTO),localStorage.removeItem(CACHE_CONFIG.STORAGE_KEY_TIMESTAMP),debugLog("üóëÔ∏è Cache de evento limpiado")}window.FirebaseDB={initFirestore:initFirestore,setEventoActual:setEventoActual,getEventoActual:getEventoActual,checkDniExists:checkDniExists,createRegistro:createRegistro,getRegistros:getRegistros,getPendientesSincronizacion:getPendientesSincronizacion,markAsSynced:markAsSynced,createOrUpdateEvento:createOrUpdateEvento,getEventoActivo:getEventoActivo};